#!/bin/sh

Errno=0
ErrMsg=""

clear
echo "Vérification des variables..."
echo -n "  Mot de passe root "
if [ "" = "$ROOT_PASSORD" ]
then
  Errno=1
  ErrMsg="La variable ROOT_PASSWORD n'est pas définie\n"
  echo "BAD"
else 
  echo "OK"
fi
echo -n "  Nom de la base "
if [ "" = "$DATABASE" ]
then
  Errno=1
  ErrMsg="La variable DATABASE n'est pas définie\n"
  echo "BAD"
else 
  echo "OK"
fi
echo -n "  Utilisateur  "
if [ "" = "$DB_USER" ]
then
  Errno=1
  ErrMsg="La variable DB_USER n'est pas définie\n"
  echo "BAD"
else 
  echo "OK"
fi
echo -n "  Mot de passe "
if [ "" = "$DB_PASS" ]
then
  Errno=1
  ErrMsg="La variable DB_PASS n'est pas définie\n"
  echo "BAD"
else 
  echo "OK"
fi
if [ Errno = 1 ]
then 
  echo -e "ERREUR\n"
  echo -e $ErrMsg
  exit 1
fi

# Créer les tables 
mysql_install_db --datadir=/var/lib/mysql/mysql
echo -e "\nInstall User Database"
echo -n "  Launch mariadb server ...  "

mkdir -p /var/lib/mysql/run/mysqld

exec mysqld_safe --datadir=/var/lib/mysql/mysql --skip-grant-tables & 2> /dev/null
sleep 2
echo "OK"

echo -n "  Assigning $HOSTNAME () as mysql_root_password  "
echo "FLUSH PRIVILEGES;"| mysql 
echo "ALTER USER 'root'@'localhost' IDENTIFIED BY '$ROOT_PASSWORD';"| mysql 
echo "OK"

echo -n "  Creating Database $DATABASE     "
echo "CREATE DATABASE $DATABASE;" | mysql
echo "OK"  
echo -n "  Granting full rights on $USER with password ($PASS) on $DB  "
echo "GRANT ALL PRIVILEGES ON $DATABASE.* TO '$DB_USER'@'%' IDENTIFIED BY '$DB_PASS';" | mysql
echo "OK"
echo -n "  Dropping test database    "
echo "DROP DATABASE test;" | mysql
echo "OK"

echo -n "  Cleaning                  "
unset $ROOTPASS
unset $PASS
unset $USER
unset $DB
kill -TERM $(pidof mysqld)
echo "OK"

echo -n "La base est prête\n"

