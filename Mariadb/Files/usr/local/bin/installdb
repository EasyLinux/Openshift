#!/bin/sh

if [ -f /etc/debian_version ]; then
  DISTRIB="Debian"
else
  DISTRIB="Alpine"
fi

clear
echo "Creation de la base sous $DISTRIB"
echo -n "Mot de passe root : "
read ROOTPASS
echo -n "Nom de la base : "
read DB
echo -n "Utilisateur de la base : "
read USER
echo -n "Mot de passe : "
read PASS

# Créer les tables 
mysql_install_db --datadir=/var/lib/mysql/mysql
echo "Install User Database"
echo -n "  Launch mariadb server ...  "

if [ "$DISTRIB" = "Debian" ]; then 
  mkdir /var/run/mysqld
  chown mysql: /var/run/mysqld
else
  mkdir -p /var/lib/mysql/run/mysqld
fi
exec mysqld_safe --datadir=/var/lib/mysql/mysql --skip-grant-tables & 2> /dev/null
sleep 2
echo "OK"

echo -n "  Assigning $HOSTNAME ($ROOTPASS) as mysql_root_password  "
echo "FLUSH PRIVILEGES;"| mysql 
echo "ALTER USER 'root'@'localhost' IDENTIFIED BY '$ROOTPASS';"| mysql 
echo "OK"

echo -n "  Creating Database $DB     "
echo "CREATE DATABASE $DB;" | mysql -u root --password="$ROOTPASS"
echo "OK"  
echo -n "  Granting full rights on $USER with password ($PASS) on $DB  "
echo "GRANT ALL PRIVILEGES ON $DB.* TO '$USER'@'%' IDENTIFIED BY '$PASS';" | mysql -u root --password="$ROOTPASS"
echo "OK"
echo -n "  Dropping test database    "
echo "DROP DATABASE test;" | mysql -u root --password="$ROOTPASS"
echo "OK"

echo -n "  Cleaning                  "
unset $ROOTPASS
unset $PASS
unset $USER
unset $DB
kill -TERM $(pidof mysqld)
echo "OK"

echo "La base est prête"
echo "Veuillez relancer le container"
